import{E as n}from"./index-XrI2zrrk.js";const d={async uploadTeamLogo(r,e){try{if(!["image/jpeg","image/png","image/webp","image/svg+xml"].includes(r.type))return{error:"Tipo de archivo no permitido. Use JPEG, PNG, WebP o SVG."};if(r.size>5*1024*1024)return{error:"El archivo es demasiado grande. Máximo 5MB."};const s=r.name.split(".").pop(),l=`logos/${`${e}-${Date.now()}.${s}`}`;await this.deleteTeamLogo(e);const{error:i}=await n.storage.from("team-logos").upload(l,r,{cacheControl:"3600",upsert:!1});if(i)return console.error("Error uploading file:",i),{error:`Error al subir archivo: ${i.message}`};const{data:{publicUrl:c}}=n.storage.from("team-logos").getPublicUrl(l);return c?{url:c}:{error:"No se pudo obtener la URL pública del archivo."}}catch(a){return console.error("Upload error:",a),{error:"Error inesperado al subir el archivo"}}},async deleteTeamLogo(r){try{const{data:e}=await n.storage.from("team-logos").list("logos",{search:r});if(e&&e.length>0){const a=e.filter(s=>s.name.startsWith(`${r}-`)).map(s=>`logos/${s.name}`);a.length>0&&await n.storage.from("team-logos").remove(a)}}catch(e){console.error("Error deleting old logo:",e)}},getPublicUrl(r){try{const{data:{publicUrl:e}}=n.storage.from("team-logos").getPublicUrl(r);return e}catch(e){return console.error("Error getting public URL:",e),null}},async validateLogoUrl(r){try{return(await fetch(r,{method:"HEAD"})).ok}catch{return!1}}},t=(r,e)=>{var a,s;throw console.error(`Error en API - ${e}:`,r),(r==null?void 0:r.code)==="PGRST301"?new Error(`Error de conexión con la base de datos durante ${e}. Por favor, revisa tu conexión a internet.`):(r==null?void 0:r.code)==="42P01"?new Error(`Tabla no encontrada en la base de datos durante ${e}. Asegúrate de que la base de datos esté configurada correctamente.`):(a=r==null?void 0:r.message)!=null&&a.includes("JWT")?new Error(`Error de autenticación durante ${e}. Por favor, inicia sesión de nuevo.`):(s=r==null?void 0:r.message)!=null&&s.includes("RLS")?new Error(`Error de permisos durante ${e}. Puede que no tengas los permisos necesarios.`):new Error(`Falló ${e}: ${r.message||"Error desconocido"}`)},_={async getAll(){try{const{data:r,error:e}=await n.from("teams").select(`
          *,
          players (*)
        `).order("name");return e&&t(e,"fetch teams"),r||[]}catch(r){return t(r,"fetch teams"),[]}},async getById(r){try{const{data:e,error:a}=await n.from("teams").select(`
          *,
          players (*)
        `).eq("id",r).single();return a&&t(a,"fetch team"),e}catch(e){throw t(e,"fetch team"),e}},async create(r){var e,a;try{if(!((e=r.name)!=null&&e.trim()))throw new Error("Team name is required");const{data:s,error:o}=await n.from("teams").insert({...r,name:r.name.trim(),coach:((a=r.coach)==null?void 0:a.trim())||null,season:r.season||"2024"}).select().single();return o&&t(o,"create team"),s}catch(s){throw t(s,"create team"),s}},async update(r,e){var a,s,o;try{if(e.name!==void 0&&!((a=e.name)!=null&&a.trim()))throw new Error("Team name cannot be empty");const{data:l,error:i}=await n.from("teams").update({...e,name:(s=e.name)==null?void 0:s.trim(),coach:((o=e.coach)==null?void 0:o.trim())||null,logo_url:e.logo_url||null,updated_at:new Date().toISOString()}).eq("id",r).select().single();return i&&t(i,"update team"),l}catch(l){throw t(l,"update team"),l}},async updateLogo(r,e){try{const{url:a,error:s}=await d.uploadTeamLogo(e,r);if(s||!a)throw new Error(s||"Failed to upload logo");return{team:await this.update(r,{logo_url:a}),logoUrl:a}}catch(a){throw t(a,"update team logo"),a}},async delete(r){try{const{data:e}=await n.from("teams").select("logo_url").eq("id",r).single();e!=null&&e.logo_url&&await d.deleteTeamLogo(r);const{error:a}=await n.from("teams").delete().eq("id",r);a&&t(a,"delete team")}catch(e){throw t(e,"delete team"),e}}},y={async getAll(r={}){const{page:e=1,limit:a=20,search:s}=r,o=(e-1)*a,l=o+a-1;try{let i=n.from("players").select(`
          *,
          teams (name),
          player_stats (*)
        `).order("name").range(o,l);s&&(i=i.ilike("name",`%${s}%`));const{data:c,error:m}=await i;m&&t(m,"fetch players");const u=(c==null?void 0:c.length)===a;return{players:c||[],hasMore:u}}catch(i){return t(i,"fetch players"),{players:[],hasMore:!1}}},async getById(r){try{const{data:e,error:a}=await n.from("players").select(`
          *,
          teams (name),
          player_stats (*)
        `).eq("id",r).single();return a&&t(a,"fetch player"),e}catch(e){throw t(e,"fetch player"),e}},async getByTeam(r){try{const{data:e,error:a}=await n.from("players").select(`
          *,
          player_stats (*)
        `).eq("team_id",r).order("jersey_number");return a&&t(a,"fetch team players"),e||[]}catch(e){return t(e,"fetch team players"),[]}},async getPlayersForGame(r,e){try{const{data:a,error:s}=await n.from("players").select(`
          *,
          player_stats (*)
        `).in("team_id",[r,e]).order("name");return s&&t(s,"fetch game players"),a||[]}catch(a){return t(a,"fetch game players"),[]}},async create(r){var e;try{if(!((e=r.name)!=null&&e.trim()))throw new Error("Player name is required");const{data:a,error:s}=await n.from("players").insert({...r,name:r.name.trim(),position:r.position||"Utility",jersey_number:r.jersey_number||null,team_id:r.team_id||null,date_of_birth:r.date_of_birth||null}).select().single();return s&&t(s,"create player"),a}catch(a){throw t(a,"create player"),a}},async update(r,e){var a,s;try{if(e.name!==void 0&&!((a=e.name)!=null&&a.trim()))throw new Error("Player name cannot be empty");const{data:o,error:l}=await n.from("players").update({...e,name:(s=e.name)==null?void 0:s.trim(),updated_at:new Date().toISOString()}).eq("id",r).select().single();return l&&t(l,"update player"),o}catch(o){throw t(o,"update player"),o}},async delete(r){try{const{error:e}=await n.from("players").delete().eq("id",r);e&&t(e,"delete player")}catch(e){throw t(e,"delete player"),e}}},f={async getAll(r={}){const{page:e=1,limit:a=20}=r,s=(e-1)*a,o=s+a-1;try{const{data:l,error:i}=await n.from("games").select(`
          *,
          home_team:teams!games_home_team_id_fkey (name),
          away_team:teams!games_away_team_id_fkey (name)
        `).order("date",{ascending:!1}).range(s,o);i&&t(i,"fetch games");const c=(l==null?void 0:l.length)===a;return{games:l||[],hasMore:c}}catch(l){return t(l,"fetch games"),{games:[],hasMore:!1}}},async getById(r){try{const{data:e,error:a}=await n.from("games").select(`
          *,
          home_team:teams!games_home_team_id_fkey (name),
          away_team:teams!games_away_team_id_fkey (name),
          player_stats (
            *,
            players (name, jersey_number, position)
          )
        `).eq("id",r).single();return a&&t(a,"fetch game"),e}catch(e){throw t(e,"fetch game"),e}},async create(r){try{if(!r.date)throw new Error("Game date is required");if(r.home_team_id&&r.away_team_id&&r.home_team_id===r.away_team_id)throw new Error("Home and away teams cannot be the same");const{data:e,error:a}=await n.from("games").insert({...r,status:r.status||"scheduled",home_score:r.home_score||0,away_score:r.away_score||0}).select().single();return a&&t(a,"create game"),e}catch(e){throw t(e,"create game"),e}},async update(r,e){try{if(e.home_team_id&&e.away_team_id&&e.home_team_id===e.away_team_id)throw new Error("Home and away teams cannot be the same");const{data:a,error:s}=await n.from("games").update({...e,updated_at:new Date().toISOString()}).eq("id",r).select().single();return s&&t(s,"update game"),a}catch(a){throw t(a,"update game"),a}},async delete(r){try{const{error:e}=await n.from("games").delete().eq("id",r);e&&t(e,"delete game")}catch(e){throw t(e,"delete game"),e}}},g={async getByGame(r){try{const{data:e,error:a}=await n.from("player_stats").select(`
          *,
          players (name, jersey_number, position)
        `).eq("game_id",r);return a&&t(a,"fetch game stats"),e||[]}catch(e){return t(e,"fetch game stats"),[]}},async getByPlayer(r){try{const{data:e,error:a}=await n.from("player_stats").select(`
          *,
          games (date, home_team:teams!games_home_team_id_fkey (name), away_team:teams!games_away_team_id_fkey (name))
        `).eq("player_id",r).order("created_at",{ascending:!1});return a&&t(a,"fetch player stats"),e||[]}catch(e){return t(e,"fetch player stats"),[]}},async upsertOne(r){try{if(!r.player_id||!r.game_id)throw new Error("Player ID and Game ID are required");const e={...r,at_bats:Math.max(0,r.at_bats||0),hits:Math.max(0,r.hits||0),runs:Math.max(0,r.runs||0),rbi:Math.max(0,r.rbi||0),doubles:Math.max(0,r.doubles||0),triples:Math.max(0,r.triples||0),home_runs:Math.max(0,r.home_runs||0),walks:Math.max(0,r.walks||0),strikeouts:Math.max(0,r.strikeouts||0),stolen_bases:Math.max(0,r.stolen_bases||0),errors:Math.max(0,r.errors||0)};if(e.hits>e.at_bats)throw new Error("Hits cannot exceed at-bats");const{data:a,error:s}=await n.from("player_stats").upsert(e,{onConflict:"player_id,game_id"}).select().single();return s&&t(s,"save player stats"),a}catch(e){throw t(e,"save player stats"),e}},async upsertMany(r){try{if(!r||r.length===0)return[];const e=r.map(o=>{if(!o.player_id||!o.game_id)throw new Error("Player ID and Game ID are required for all stats");return{...o,at_bats:Math.max(0,o.at_bats||0),hits:Math.max(0,o.hits||0),runs:Math.max(0,o.runs||0),rbi:Math.max(0,o.rbi||0),doubles:Math.max(0,o.doubles||0),triples:Math.max(0,o.triples||0),home_runs:Math.max(0,o.home_runs||0),walks:Math.max(0,o.walks||0),strikeouts:Math.max(0,o.strikeouts||0),stolen_bases:Math.max(0,o.stolen_bases||0),errors:Math.max(0,o.errors||0)}});for(const o of e)if(o.hits>o.at_bats)throw new Error(`Player ${o.player_id} hits cannot exceed at-bats`);const{data:a,error:s}=await n.from("player_stats").upsert(e,{onConflict:"player_id,game_id"}).select();return s&&t(s,"save player stats"),a}catch(e){throw t(e,"save player stats"),e}},async delete(r){try{const{error:e}=await n.from("player_stats").delete().eq("id",r);e&&t(e,"delete player stats")}catch(e){throw t(e,"delete player stats"),e}}},p=r=>{if(!r||r.length===0)return{games:0,at_bats:0,hits:0,runs:0,rbi:0,doubles:0,triples:0,home_runs:0,walks:0,strikeouts:0,stolen_bases:0,errors:0,avg:0,obp:0,slg:0,ops:0};const e=r.reduce((i,c)=>({games:i.games+1,at_bats:i.at_bats+c.at_bats,hits:i.hits+c.hits,runs:i.runs+c.runs,rbi:i.rbi+c.rbi,doubles:i.doubles+c.doubles,triples:i.triples+c.triples,home_runs:i.home_runs+c.home_runs,walks:i.walks+c.walks,strikeouts:i.strikeouts+c.strikeouts,stolen_bases:i.stolen_bases+c.stolen_bases,errors:i.errors+c.errors}),{games:0,at_bats:0,hits:0,runs:0,rbi:0,doubles:0,triples:0,home_runs:0,walks:0,strikeouts:0,stolen_bases:0,errors:0}),a=e.at_bats>0?e.hits/e.at_bats:0,s=e.at_bats+e.walks>0?(e.hits+e.walks)/(e.at_bats+e.walks):0,o=e.at_bats>0?(e.hits-e.doubles-e.triples-e.home_runs+e.doubles*2+e.triples*3+e.home_runs*4)/e.at_bats:0,l=s+o;return{...e,avg:Number(a.toFixed(3)),obp:Number(s.toFixed(3)),slg:Number(o.toFixed(3)),ops:Number(l.toFixed(3))}},w={async getAllUsers(){try{const{data:r,error:e}=await n.from("user_profiles").select("*").order("created_at",{ascending:!1});return e&&t(e,"fetch users"),r||[]}catch(r){return t(r,"fetch users"),[]}},async updateUserRole(r,e){try{const{data:a,error:s}=await n.from("user_profiles").update({role:e,updated_at:new Date().toISOString()}).eq("uid",r).select().single();return s&&t(s,"update user role"),a}catch(a){throw t(a,"update user role"),a}},async createRoleChangeRequest(r,e,a,s){try{const{data:o,error:l}=await n.from("role_change_requests").insert({target_user_id:r,from_role:e,to_role:a,reason:s||null,status:"pending"}).select().single();return l&&t(l,"create role change request"),o}catch(o){throw t(o,"create role change request"),o}},async getRoleChangeRequests(){try{const{data:r,error:e}=await n.from("role_change_requests").select(`
          *,
          requester:user_profiles!role_change_requests_requester_id_fkey(username, email, role),
          target_user:user_profiles!role_change_requests_target_user_id_fkey(username, email, role),
          reviewer:user_profiles!role_change_requests_reviewed_by_fkey(username, email, role)
        `).order("created_at",{ascending:!1});return e&&t(e,"fetch role change requests"),r||[]}catch(r){return t(r,"fetch role change requests"),[]}},async reviewRoleChangeRequest(r,e){try{const{data:a,error:s}=await n.from("role_change_requests").update({status:e,reviewed_at:new Date().toISOString()}).eq("id",r).select().single();return s&&t(s,"review role change request"),e==="approved"&&a&&await this.updateUserRole(a.target_user_id,a.to_role),a}catch(a){throw t(a,"review role change request"),a}}};export{g as a,p as c,f as g,y as p,_ as t,w as u};
